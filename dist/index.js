"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const p=require("react/jsx-runtime"),y=require("axios"),r=require("react"),h=require("react-router-dom"),U=t=>t&&t.__esModule?t:{default:t},O=U(y);exports.AuthStatus=void 0;(function(t){t.NotSure="not_sure",t.LoggedIn="logged_in",t.NotLoggedIn="not_logged_in",t.LoggedOut="logged_out"})(exports.AuthStatus||(exports.AuthStatus={}));const N=r.createContext({status:exports.AuthStatus.NotSure,setStatus:()=>null,user:null,setUser:()=>null,token:null,setToken:()=>null,fetchUser:()=>null,loginPath:"/login",logoutRedirectPath:"/",defaultAxiosOptions:void 0}),x=(t,e)=>{const[o,u]=r.useState(()=>{const n=localStorage.getItem(t);try{return n?JSON.parse(n):e}catch(a){return console.error("Invalid JSON:",a),e}});return r.useEffect(()=>{localStorage.setItem(t,o?JSON.stringify(o):"{}")},[t,o]),[o,u]};function I({children:t,fetchUserInterval:e=0,getCurrentUserPath:o="/user",loginPath:u="/login",logoutRedirectPath:n="/",defaultAxiosOptions:a={}}){const g=r.useRef(),[S,i]=x("auth_status",exports.AuthStatus.NotSure),[m,c]=x("auth_user",null),[A,_]=x("auth_token",null),[L,b]=r.useState(0);A&&(O.default.defaults.headers.Authorization=`Bearer ${A}`);const f=r.useCallback(()=>{g.current=O.default.get(o,a).then(l=>{i(exports.AuthStatus.LoggedIn),c(l.data)}).catch(l=>{console.error(l),i(exports.AuthStatus.NotLoggedIn)})},[]);if(r.useEffect(()=>{f()},[f,L]),r.useEffect(()=>{let l=0;return e>0&&(l=window.setInterval(f,Math.max(e,3e3))),()=>{clearInterval(l)}},[f,e]),S===exports.AuthStatus.NotSure&&g.current)throw g.current;return p.jsx(N.Provider,{value:{status:S,setStatus:i,user:m,setUser:c,token:A,setToken:_,fetchUser:()=>b(l=>l+1),loginPath:u,logoutRedirectPath:n,defaultAxiosOptions:a},children:t})}function v(){return r.useContext(N)}function P({to:t}){var e,o;const u=v(),n=h.useLocation();return u.status===exports.AuthStatus.LoggedIn?p.jsx(h.Navigate,{to:((o=(e=n.state)===null||e===void 0?void 0:e.from)===null||o===void 0?void 0:o.pathname)||t||"/"}):null}function j({children:t}){const e=v(),o=h.useLocation(),u=h.useNavigate();return r.useEffect(()=>{e.status===exports.AuthStatus.LoggedOut&&(u(e.logoutRedirectPath),e.setStatus(exports.AuthStatus.NotLoggedIn))},[e,u]),e.status===exports.AuthStatus.NotLoggedIn?p.jsx(h.Navigate,{to:e.loginPath,state:{from:o}}):p.jsx(p.Fragment,{children:t})}function R(t,e){const{errorHandler:o=s=>console.error(s),apiUrl:u="/login",getUserFromResponse:n=s=>s==null?void 0:s.user,getJwtTokenFromResponse:a=s=>{var d;return((d=s==null?void 0:s.token)===null||d===void 0?void 0:d.token)||(s==null?void 0:s.token)},actionAxiosOptions:g=null}=e||{},{setStatus:S,setUser:i,setToken:m,fetchUser:c,defaultAxiosOptions:A}=v(),[_,L]=r.useState(!1),[b,f]=r.useState(null);return{submit:()=>(L(!0),O.default.post(u,t,g||A||{}).then(s=>(S(exports.AuthStatus.LoggedIn),typeof n=="function"?i(n(s.data)):c(),typeof a=="function"&&m(a(s.data)),f(null),s)).catch(s=>{var d;f(((d=s.response)===null||d===void 0?void 0:d.data)||s.message||"Unknown error"),o&&o(s)}).finally(()=>{L(!1)})),loading:_,errors:b}}function k(t){const{errorHandler:e=c=>console.error(c),apiUrl:o="/logout",actionAxiosOptions:u=null}=t||{},{setStatus:n,setUser:a,defaultAxiosOptions:g}=v(),[S,i]=r.useState(!1);return{submit:()=>(i(!0),O.default.post(o,null,u||g||{}).then(c=>(n(exports.AuthStatus.LoggedOut),a(null),c)).catch(e).finally(()=>{i(!1)})),loading:S}}var q=globalThis&&globalThis.__rest||function(t,e){var o={};for(var u in t)Object.prototype.hasOwnProperty.call(t,u)&&e.indexOf(u)<0&&(o[u]=t[u]);if(t!=null&&typeof Object.getOwnPropertySymbols=="function")for(var n=0,u=Object.getOwnPropertySymbols(t);n<u.length;n++)e.indexOf(u[n])<0&&Object.prototype.propertyIsEnumerable.call(t,u[n])&&(o[u[n]]=t[u[n]]);return o};function w(t,e){const o=e||{},{apiUrl:u="/register"}=o,n=q(o,["apiUrl"]);return R(t,Object.assign({apiUrl:u},n))}function T(){const t=v(),e=h.useLocation(),o=h.useNavigate();return r.useCallback(()=>t.status===exports.AuthStatus.NotLoggedIn?(o(t.loginPath,{state:{from:e}}),!1):!0,[t,e,o])}exports.AuthProvider=I;exports.RedirectAfterAuth=P;exports.RequireAuth=j;exports.useAuth=v;exports.useLogin=R;exports.useLogout=k;exports.useRegister=w;exports.useRequireAuth=T;
