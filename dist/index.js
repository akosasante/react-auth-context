"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const A=require("react/jsx-runtime"),y=require("axios"),r=require("react"),d=require("react-router-dom"),U=t=>t&&t.__esModule?t:{default:t},L=U(y);exports.AuthStatus=void 0;(function(t){t.NotSure="not_sure",t.LoggedIn="logged_in",t.NotLoggedIn="not_logged_in",t.LoggedOut="logged_out"})(exports.AuthStatus||(exports.AuthStatus={}));const R=r.createContext({status:exports.AuthStatus.NotSure,setStatus:()=>null,user:null,setUser:()=>null,token:null,setToken:()=>null,fetchUser:()=>null,loginPath:"/login",logoutRedirectPath:"/",defaultAxiosOptions:void 0}),N=(t,e)=>{const[o,u]=r.useState(()=>{const n=localStorage.getItem(t);try{return n?JSON.parse(n):e}catch(a){return console.error("Invalid JSON:",a),e}});return r.useEffect(()=>{localStorage.setItem(t,o?JSON.stringify(o):"{}")},[t,o]),[o,u]};function I({children:t,fetchUserInterval:e=0,getCurrentUserPath:o="/user",loginPath:u="/login",logoutRedirectPath:n="/",defaultAxiosOptions:a={}}){const i=r.useRef(),[S,c]=N("auth_status",exports.AuthStatus.NotSure),[_,p]=N("auth_user",null),[v,O]=N("auth_token",null),[m,b]=r.useState(0);v&&(L.default.defaults.headers.Authorization=`Bearer ${v}`);const g=r.useCallback(()=>{i.current=L.default.get(o,a).then(l=>{c(exports.AuthStatus.LoggedIn),p(l.data)}).catch(l=>{console.error(l),c(exports.AuthStatus.NotLoggedIn)})},[]);if(r.useEffect(()=>{g()},[g,m]),r.useEffect(()=>{let l=0;return e>0&&(l=window.setInterval(g,Math.max(e,3e3))),()=>{clearInterval(l)}},[g,e]),S===exports.AuthStatus.NotSure&&i.current)throw i.current;return A.jsx(R.Provider,{value:{status:S,setStatus:c,user:_,setUser:p,token:v,setToken:O,fetchUser:()=>b(l=>l+1),loginPath:u,logoutRedirectPath:n,defaultAxiosOptions:a},children:t})}function h(){return r.useContext(R)}function P({to:t}){var e,o;const u=h(),n=d.useLocation();return u.status===exports.AuthStatus.LoggedIn?A.jsx(d.Navigate,{to:((o=(e=n.state)===null||e===void 0?void 0:e.from)===null||o===void 0?void 0:o.pathname)||t||"/"}):null}function j({children:t}){const e=h(),o=d.useLocation(),u=d.useNavigate();return r.useEffect(()=>{e.status===exports.AuthStatus.LoggedOut&&(u(e.logoutRedirectPath),e.setStatus(exports.AuthStatus.NotLoggedIn))},[e,u]),e.status===exports.AuthStatus.NotLoggedIn?A.jsx(d.Navigate,{to:e.loginPath,state:{from:o}}):A.jsx(A.Fragment,{children:t})}function x(t,e){const{errorHandler:o=s=>console.error(s),apiUrl:u="/login",getUserFromResponse:n=s=>s==null?void 0:s.user,getJwtTokenFromResponse:a=s=>{var f;return((f=s==null?void 0:s.token)===null||f===void 0?void 0:f.token)||(s==null?void 0:s.token)},actionAxiosOptions:i=null}=e||{},{setStatus:S,setUser:c,setToken:_,fetchUser:p,defaultAxiosOptions:v}=h(),[O,m]=r.useState(!1),[b,g]=r.useState(null);return{submit:()=>(m(!0),L.default.post(u,t,i||v||{}).then(s=>{S(exports.AuthStatus.LoggedIn),typeof n=="function"?c(n(s.data)):p(),typeof a=="function"&&_(a(s.data)),g(null)}).catch(s=>{var f;g(((f=s.response)===null||f===void 0?void 0:f.data)||s.message||"Unknown error"),o&&o(s)}).finally(()=>{m(!1)})),loading:O,errors:b}}function k(t){const{errorHandler:e=c=>console.error(c),apiUrl:o="/logout"}=t||{},{setStatus:u,setUser:n}=h(),[a,i]=r.useState(!1);return{submit:()=>(i(!0),L.default.post(o).then(()=>{u(exports.AuthStatus.LoggedOut),n(null)}).catch(e).finally(()=>{i(!1)})),loading:a}}var q=globalThis&&globalThis.__rest||function(t,e){var o={};for(var u in t)Object.prototype.hasOwnProperty.call(t,u)&&e.indexOf(u)<0&&(o[u]=t[u]);if(t!=null&&typeof Object.getOwnPropertySymbols=="function")for(var n=0,u=Object.getOwnPropertySymbols(t);n<u.length;n++)e.indexOf(u[n])<0&&Object.prototype.propertyIsEnumerable.call(t,u[n])&&(o[u[n]]=t[u[n]]);return o};function w(t,e){const o=e||{},{apiUrl:u="/register"}=o,n=q(o,["apiUrl"]);return x(t,Object.assign({apiUrl:u},n))}function T(){const t=h(),e=d.useLocation(),o=d.useNavigate();return r.useCallback(()=>t.status===exports.AuthStatus.NotLoggedIn?(o(t.loginPath,{state:{from:e}}),!1):!0,[t,e,o])}exports.AuthProvider=I;exports.RedirectAfterAuth=P;exports.RequireAuth=j;exports.useAuth=h;exports.useLogin=x;exports.useLogout=k;exports.useRegister=w;exports.useRequireAuth=T;
