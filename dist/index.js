"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const p=require("react/jsx-runtime"),R=require("axios"),r=require("react"),h=require("react-router-dom"),I=t=>t&&t.__esModule?t:{default:t},O=I(R);exports.AuthStatus=void 0;(function(t){t.NotSure="not_sure",t.LoggedIn="logged_in",t.NotLoggedIn="not_logged_in",t.LoggedOut="logged_out"})(exports.AuthStatus||(exports.AuthStatus={}));const x=r.createContext({status:exports.AuthStatus.NotSure,setStatus:()=>null,user:null,setUser:()=>null,token:null,setToken:()=>null,fetchUser:()=>null,loginPath:"/login",logoutRedirectPath:"/",defaultAxiosOptions:void 0}),N=(t,e)=>{const[o,n]=r.useState(()=>{const u=localStorage.getItem(t);try{return u?JSON.parse(u):e}catch(a){return console.error("Invalid JSON:",a),e}});return r.useEffect(()=>{localStorage.setItem(t,o?JSON.stringify(o):JSON.stringify(e)||"{}")},[t,o]),[o,n]};function U({children:t,fetchUserInterval:e=0,getCurrentUserPath:o="/user",loginPath:n="/login",logoutRedirectPath:u="/",defaultAxiosOptions:a={}}){const g=r.useRef(),[S,i]=N("auth_status",exports.AuthStatus.NotSure),[m,l]=N("auth_user",null),[A,_]=N("auth_token",null),[L,b]=r.useState(0);A&&(O.default.defaults.headers.Authorization=`Bearer ${A}`);const f=r.useCallback(()=>{g.current=O.default.get(o,a).then(c=>{i(exports.AuthStatus.LoggedIn),l(c.data)}).catch(c=>{console.error(c),i(exports.AuthStatus.NotLoggedIn)})},[a,o,i,l]);if(r.useEffect(()=>{f()},[f,L]),r.useEffect(()=>{let c=0;return e>0&&(c=window.setInterval(f,Math.max(e,3e3))),()=>{clearInterval(c)}},[f,e]),S===exports.AuthStatus.NotSure&&g.current)throw g.current;return p.jsx(x.Provider,{value:{status:S,setStatus:i,user:m,setUser:l,token:A,setToken:_,fetchUser:()=>b(c=>c+1),loginPath:n,logoutRedirectPath:u,defaultAxiosOptions:a},children:t})}function v(){return r.useContext(x)}function j({to:t}){var e,o;const n=v(),u=h.useLocation();return n.status===exports.AuthStatus.LoggedIn?p.jsx(h.Navigate,{to:((o=(e=u.state)===null||e===void 0?void 0:e.from)===null||o===void 0?void 0:o.pathname)||t||"/"}):null}function k({children:t}){const e=v(),o=h.useLocation(),n=h.useNavigate();return r.useEffect(()=>{e.status===exports.AuthStatus.LoggedOut&&(n(e.logoutRedirectPath),e.setStatus(exports.AuthStatus.NotLoggedIn))},[e,n]),e.status===exports.AuthStatus.NotLoggedIn?p.jsx(h.Navigate,{to:e.loginPath,state:{from:o}}):p.jsx(p.Fragment,{children:t})}function y(t,e){const{errorHandler:o=s=>console.error(s),apiUrl:n="/login",getUserFromResponse:u=s=>s==null?void 0:s.user,getJwtTokenFromResponse:a=s=>{var d;return((d=s==null?void 0:s.token)===null||d===void 0?void 0:d.token)||(s==null?void 0:s.token)},actionAxiosOptions:g=null}=e||{},{setStatus:S,setUser:i,setToken:m,fetchUser:l,defaultAxiosOptions:A}=v(),[_,L]=r.useState(!1),[b,f]=r.useState(null);return{submit:()=>(L(!0),O.default.post(n,t,g||A||{}).then(s=>(S(exports.AuthStatus.LoggedIn),typeof u=="function"?i(u(s.data)):l(),typeof a=="function"&&m(a(s.data)),f(null),s)).catch(s=>{var d;f(((d=s.response)===null||d===void 0?void 0:d.data)||s.message||"Unknown error"),o&&o(s)}).finally(()=>{L(!1)})),loading:_,errors:b}}function P(t){const{errorHandler:e=l=>console.error(l),apiUrl:o="/logout",actionAxiosOptions:n=null}=t||{},{setStatus:u,setUser:a,defaultAxiosOptions:g}=v(),[S,i]=r.useState(!1);return{submit:()=>(i(!0),O.default.post(o,null,n||g||{}).then(l=>(u(exports.AuthStatus.LoggedOut),a(null),l)).catch(e).finally(()=>{i(!1)})),loading:S}}var q=globalThis&&globalThis.__rest||function(t,e){var o={};for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&e.indexOf(n)<0&&(o[n]=t[n]);if(t!=null&&typeof Object.getOwnPropertySymbols=="function")for(var u=0,n=Object.getOwnPropertySymbols(t);u<n.length;u++)e.indexOf(n[u])<0&&Object.prototype.propertyIsEnumerable.call(t,n[u])&&(o[n[u]]=t[n[u]]);return o};function w(t,e){const o=e||{},{apiUrl:n="/register"}=o,u=q(o,["apiUrl"]);return y(t,Object.assign({apiUrl:n},u))}function T(){const t=v(),e=h.useLocation(),o=h.useNavigate();return r.useCallback(()=>t.status===exports.AuthStatus.NotLoggedIn?(o(t.loginPath,{state:{from:e}}),!1):!0,[t,e,o])}exports.AuthProvider=U;exports.RedirectAfterAuth=j;exports.RequireAuth=k;exports.useAuth=v;exports.useLogin=y;exports.useLogout=P;exports.useRegister=w;exports.useRequireAuth=T;
